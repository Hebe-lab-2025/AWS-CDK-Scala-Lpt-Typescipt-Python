## ğŸ§ª 8 é“ `!Ref / !Sub / !GetAtt` æ˜“é”™é¢˜ï¼ˆçœŸè€ƒé£ï¼‰

> æ ¼å¼ï¼š**é¢˜ç›® â†’ é€‰é¡¹ â†’ æ­£è§£ â†’ ä¸€å¥è¯å‘ç‚¹**

### 1) `!Ref` åˆ°åº•è¿”å›ä»€ä¹ˆï¼Ÿ

ä½ å†™ï¼š`BucketName: !Ref MyBucket`ï¼Œ`MyBucket` æ˜¯ `AWS::S3::Bucket`
A. è¿”å› Bucket ARN
B. è¿”å› Bucket ç‰©ç†åï¼ˆbucket nameï¼‰
C. è¿”å› Logical ID `"MyBucket"`
D. è¿”å› URL

âœ… æ­£è§£ï¼š**B**
å‘ç‚¹ï¼š`Ref` å¯¹**èµ„æº**è¿”å›çš„æ˜¯è¯¥èµ„æºçš„â€œRef è¿”å›å€¼â€ï¼ˆé€šå¸¸æ˜¯ç‰©ç† ID/Nameï¼‰ï¼Œä¸æ˜¯ ARNï¼ˆå¤šæ•° ARN è¦ `!GetAtt`ï¼‰ã€‚

---

### 2) `!GetAtt` å– S3 Bucket ARN åº”è¯¥æ€ä¹ˆå†™ï¼Ÿ

A. `!GetAtt MyBucket.Arn`
B. `!GetAtt [MyBucket, Arn]`
C. ä¸¤è€…éƒ½å¯¹
D. ä¸¤è€…éƒ½é”™

âœ… æ­£è§£ï¼š**C**
å‘ç‚¹ï¼šYAML æ”¯æŒä¸¤ç§ç­‰ä»·è¯­æ³•ï¼š`Resource.Attribute` æˆ–æ•°ç»„å†™æ³•ã€‚

---

### 3) ä¸‹é¢å“ªä¸ªå†™æ³•ä¼šç›´æ¥æŠ¥é”™ï¼ˆYAML çº§åˆ«ï¼‰ï¼Ÿ

A. `Value: "arn:aws:s3:::${MyBucket}/*"`
B. `Value: !Sub "arn:aws:s3:::${MyBucket}/*"`
C. `Value: !Sub "arn:aws:s3:::${MyBucket.BucketName}/*"`
D. `Value: !Sub "arn:aws:s3:::${MyBucket.Arn}"`

âœ… æ­£è§£ï¼š**A**
å‘ç‚¹ï¼šå­—ç¬¦ä¸²é‡Œçš„ `${...}` **ä¸ä¼šè‡ªåŠ¨æ›¿æ¢**ï¼Œå¿…é¡» `!Sub` æ‰ä¼šåš substitutionã€‚

---

### 4) `!Sub` é‡Œ `${MyBucket}` å’Œ `${MyBucket.Arn}` æœ‰å•¥åŒºåˆ«ï¼Ÿ

A. å®Œå…¨ä¸€æ ·
B. `${MyBucket}` ç­‰äº `!GetAtt MyBucket.Arn`
C. `${MyBucket}` ç­‰äº `!Ref MyBucket`
D. `${MyBucket.Arn}` ç­‰äº `!Ref MyBucket`

âœ… æ­£è§£ï¼š**C**
å‘ç‚¹ï¼šåœ¨ `!Sub` é‡Œ `${LogicalId}` é»˜è®¤ç­‰ä»·äº **`Ref`**ï¼›`${LogicalId.Attribute}` æ‰åƒ **`GetAtt`**ã€‚

---

### 5) IAM Policy é‡Œå†™ S3 èµ„æº ARNï¼Œä¸‹é¢å“ªä¸ªæœ€å¸¸è§çš„â€œæƒé™æ²¡ç”Ÿæ•ˆâ€å‘ï¼Ÿ

ä½ è¦å…è®¸è¯»å¯¹è±¡ï¼š`s3:GetObject`
A. Resource åªå†™ `arn:aws:s3:::bucketname`
B. Resource å†™ `arn:aws:s3:::bucketname/*`
C. Action å†™ `s3:GetObject`
D. Principal å†™ `*`

âœ… æ­£è§£ï¼š**A**
å‘ç‚¹ï¼š`GetObject` ä½œç”¨åœ¨**å¯¹è±¡**ï¼ŒResource å¿…é¡»æ˜¯ `bucket/*`ï¼Œåªç»™ bucket ARN ä¼šå¯¼è‡´ AccessDeniedã€‚

---

### 6) `!Ref AWS::Region` æ˜¯å¦åˆæ³•ï¼Ÿ

A. åˆæ³•ï¼Œè¿”å›å½“å‰ Region
B. ä¸åˆæ³•ï¼Œå¿…é¡» `!Sub ${AWS::Region}`
C. ä¸åˆæ³•ï¼Œå¿…é¡» `!GetAtt`
D. åªæœ‰ SAM é‡Œåˆæ³•

âœ… æ­£è§£ï¼š**A**
å‘ç‚¹ï¼š`AWS::Region` æ˜¯ **Pseudo Parameter**ï¼Œå¯ä»¥ç›´æ¥ `!Ref`ã€‚

---

### 7) `!Sub` çš„ç¬¬äºŒå‚æ•° Map å¸¸è§é”™åœ¨å“ªé‡Œï¼Ÿ

ä½ å†™ï¼š

```yaml
Value: !Sub
  - "hello-${Name}"
  - Name: !Ref MyParam
```

A. æ­£ç¡®
B. é”™ï¼šç¬¬äºŒæ®µå¿…é¡»æ˜¯æ•°ç»„
C. é”™ï¼šç¬¬äºŒæ®µå¿…é¡»å†™æˆ `{Name: ...}`
D. é”™ï¼š`Name` åªèƒ½æ˜¯èµ„æºä¸èƒ½æ˜¯å‚æ•°

âœ… æ­£è§£ï¼š**A**
å‘ç‚¹ï¼š`!Sub` æ”¯æŒä¸¤æ®µå¼ï¼š`[æ¨¡æ¿å­—ç¬¦ä¸², å˜é‡æ˜ å°„]`ï¼ˆYAML ä¸‹å†™æˆä¸¤è¡Œå—ä¹Ÿ OKï¼‰ã€‚

---

### 8) ä¸‹é¢å“ªä¸ªä¼šåœ¨éƒ¨ç½²æ—¶å¤±è´¥ï¼ˆè€Œä¸æ˜¯ lint é˜¶æ®µå°±å¤±è´¥ï¼‰ï¼Ÿ

A. `!GetAtt SomeBucket.Arn`ï¼Œä½† `SomeBucket` ä¸å­˜åœ¨
B. `!Ref SomeBucket`ï¼Œä½† `SomeBucket` ä¸å­˜åœ¨
C. `!Sub "x-${SomeBucket}"`ï¼Œä½† `SomeBucket` ä¸å­˜åœ¨
D. ä»¥ä¸Šéƒ½å¯èƒ½å¤±è´¥ï¼Œä½†æ—¶æœºä¸åŒ

âœ… æ­£è§£ï¼š**D**
å‘ç‚¹ï¼šæœ‰çš„é”™è¯¯æ˜¯ **æ¨¡æ¿è§£æ/éªŒè¯æœŸ**æš´éœ²ï¼Œæœ‰çš„è¦åˆ° **Transform/åˆ›å»ºèµ„æº**æ—¶æ‰çˆ†ï¼ˆå°¤å…¶æ··åˆ SAM Transform æ—¶æ›´â€œæ™šçˆ†â€ï¼‰ã€‚

---

## ğŸ§  YAML â†’ CF Parser â†’ Resource æ‰§è¡Œæµç¨‹å›¾ï¼ˆå« Intrinsicsï¼‰

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1) You write template.yaml (SAM/CFN YAML)                 â”‚
â”‚    - Resources/Parameters/Outputs                         â”‚
â”‚    - Intrinsics: !Ref !Sub !GetAtt ...                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     |
                     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2) YAML Loader                                             â”‚
â”‚    - Parse YAML into structured model (maps/lists/scalars) â”‚
â”‚    - Tags like !Ref become nodes (not executed yet)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     |
                     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3) (If SAM) Transform Phase                                â”‚
â”‚    - AWS::Serverless-2016-10-31 expands into AWS::*        â”‚
â”‚    - Generates/rewrites resources (Api/Lambda/Role/etc.)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     |
                     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4) CloudFormation Template Validation                      â”‚
â”‚    - Schema checks (resource types/properties)             â”‚
â”‚    - Reference checks (logical ids / pseudo params)        â”‚
â”‚    - Builds dependency graph (implicit + DependsOn)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     |
                     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5) Evaluation (two â€œwavesâ€)                                â”‚
â”‚    Wave A: Resolve what can be resolved now                â”‚
â”‚      - Params defaults/overrides                           â”‚
â”‚      - Pure functions if inputs known                      â”‚
â”‚    Wave B: After resource creation, resolve late bindings  â”‚
â”‚      - !Ref resource -> physical id/name                   â”‚
â”‚      - !GetAtt -> attribute/arn/etc.                       â”‚
â”‚      - !Sub referencing resources/attrs                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     |
                     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6) Provisioning (Create/Update Stack)                      â”‚
â”‚    - Create resources in dependency order                  â”‚
â”‚    - Pass resolved values into downstream resources        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     |
                     v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7) Outputs computed + returned                             â”‚
â”‚    - You get ApiUrl / BucketName / ARNs / etc.             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” â€œè¿™é‡Œä¸ºä»€ä¹ˆå¿…é¡»ç”¨ `!Sub`â€é€è¡Œç‚¹è¯„ï¼ˆä½ æ²¡è´´ templateï¼Œæˆ‘ç›´æ¥æŒ‰ä½ ç°åœ¨ SAM Lab/å¸¸è§æ¨¡æ¿åš**å¯¹ä½ç‚¹è¯„æ¨¡æ¿**ï¼‰

> ä½ æŠŠä½ çš„ `template.yaml` è´´å‡ºæ¥åï¼Œæˆ‘å¯ä»¥æŒ‰**ä½ çœŸå®æ¯ä¸€è¡Œ**æ ‡æ³¨ï¼›
> ç°åœ¨å…ˆç»™ä½ ä¸€ä»½ï¼š**çœ‹åˆ°è¿™ç§è¡Œ â†’ 99% å¿…é¡» `!Sub` çš„åŸå› **ï¼ˆç›´æ¥å¯å¯¹ç…§æ”¹ï¼‰ã€‚

### è§„åˆ™ 1ï¼šåªè¦å­—ç¬¦ä¸²é‡Œå‡ºç° `${...}`ï¼Œå°±å¿…é¡» `!Sub`

**å…¸å‹è¡Œï¼šS3 Bucket Policy / IAM Policy çš„ Resource**

```yaml
Resource: "arn:aws:s3:::${WebBucket}/*"     # âŒ ä¸ä¼šæ›¿æ¢
Resource: !Sub "arn:aws:s3:::${WebBucket}/*" # âœ… ä¼šæ›¿æ¢
```

ä¸ºä»€ä¹ˆå¿…é¡»ï¼š`${WebBucket}` ä¸æ˜¯ YAML ç‰¹æ€§ï¼Œæ˜¯ CloudFormation substitution è¯­æ³•ï¼Œåªåœ¨ `Fn::Sub` ç”Ÿæ•ˆã€‚

---

### è§„åˆ™ 2ï¼šä½ æƒ³æŠŠ â€œRef + æ–‡å­—æ‹¼æ¥â€ å†™åœ¨ä¸€è¡Œï¼Œå°±ç”¨ `!Sub`

**å…¸å‹è¡Œï¼šAPI Invoke URL / Website URL / ARN æ‹¼æ¥**

```yaml
Value: !Sub "https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
```

ä¸ºä»€ä¹ˆå¿…é¡»ï¼šä½ åœ¨æ‹¼æ¥ **å¤šæ®µå˜é‡ + å›ºå®šå­—ç¬¦ä¸²**ï¼Œ`!Join` å¯åšä½†æ›´å•°å—¦ï¼›`!Sub` æœ€ç¨³ã€æœ€å¯è¯»ã€‚

---

### è§„åˆ™ 3ï¼šå½“ä½ éœ€è¦ `${LogicalId.Attribute}`ï¼ˆåƒ GetAttï¼‰æ—¶ï¼Œ`!Sub` ä¹Ÿæœ€é¡º

```yaml
Value: !Sub "LambdaArn=${MyFunc.Arn}"
```

ä¸ºä»€ä¹ˆå¿…é¡»ï¼šä½ éœ€è¦ä¸€ä¸ªå®Œæ•´å­—ç¬¦ä¸²é‡Œæ’å…¥å±æ€§ï¼›å½“ç„¶ä¹Ÿå¯ä»¥ `!Join` + `!GetAtt`ï¼Œä½†æ›´é•¿ã€æ˜“é”™ã€‚

---

### è§„åˆ™ 4ï¼šåˆ«ç”¨ `!Sub` çš„æƒ…å†µï¼ˆå¾ˆå¤šäººåè¿‡æ¥ç”¨é”™ï¼‰

**å¦‚æœä½ åªæ˜¯è¦ä¸€ä¸ªå€¼ï¼Œä¸æ‹¼æ¥ï¼šç”¨ `!Ref` / `!GetAtt` æ›´æ¸…æ¥š**

```yaml
BucketName: !Ref WebBucket           # âœ… ä¸éœ€è¦ !Sub
FunctionArn: !GetAtt MyFunc.Arn      # âœ… ä¸éœ€è¦ !Sub
```

ä¸ºä»€ä¹ˆï¼š`!Sub` æ˜¯â€œå­—ç¬¦ä¸²æ¨¡æ¿â€ï¼Œä¸æ˜¯â€œä¸‡èƒ½å¼•ç”¨â€ã€‚

---

### è§„åˆ™ 5ï¼šS3 å¯¹è±¡ ARNã€Lambda Invoke æƒé™æœ€å®¹æ˜“å†™é”™ï¼šè¿™ä¸¤ç±»æˆ‘ç»™ä½ â€œæ ‡å‡†å¥å¼â€

**S3 è¯»å¯¹è±¡ï¼ˆGetObjectï¼‰**ï¼š

```yaml
Resource:
  - !Sub "arn:aws:s3:::${WebBucket}/*"
```

**S3 åˆ—ç›®å½•ï¼ˆListBucketï¼‰**ï¼š

```yaml
Resource:
  - !Sub "arn:aws:s3:::${WebBucket}"
```

**Lambda permissionï¼ˆApiGw è°ƒ Lambdaï¼‰**å¸¸è§å†™æ³•ï¼š

```yaml
SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ServerlessRestApi}/*/*"
```

---

## âœ… ç»™ä½ ä¸€ä»½â€œé€è¡Œç‚¹è¯„â€çš„è¾“å‡ºé•¿ç›¸ï¼ˆä½ è´´æ¨¡æ¿åæˆ‘å°±æŒ‰è¿™ä¸ªæ ¼å¼ç»™ï¼‰

```yaml
Resources:
  WebBucket:
    Type: AWS::S3::Bucket

  WebBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebBucket
      PolicyDocument:
        Statement:
          - Action: s3:GetObject
            Resource: !Sub "arn:aws:s3:::${WebBucket}/*"   # âœ… å¿…é¡» !Subï¼šå­—ç¬¦ä¸²é‡Œè¦æ›¿æ¢ bucket å
            Principal: "*"
```

---

å¦‚æœä½ ç°åœ¨æŠŠ `template.yaml`ï¼ˆæˆ– `.aws-sam/build/template.yaml`ï¼‰ç›´æ¥è´´å‡ºæ¥ï¼Œæˆ‘ä¼šæŒ‰**ä½ çš„çœŸå®æ¯ä¸€è¡Œ**è¾“å‡ºï¼š

* âœ… è¿™é‡Œè¯¥ç”¨ `!Ref`ï¼ˆä¸ºä»€ä¹ˆï¼‰
* âœ… è¿™é‡Œè¯¥ç”¨ `!GetAtt`ï¼ˆè¿”å›ä»€ä¹ˆï¼‰
* âœ… è¿™é‡Œå¿…é¡» `!Sub`ï¼ˆä¸ç„¶å“ªé‡Œä¼šåã€ä¼šæŠ¥ä»€ä¹ˆé”™ï¼‰
* ğŸ”¥ é¡ºæ‰‹æŠŠæœ€å®¹æ˜“ AccessDenied çš„ policy resource ä¹Ÿå¸®ä½ ä¸€æ¬¡æ€§çº æ­£æ‰ï¼ˆå¯¹è±¡ vs bucket ARNï¼‰ã€‚
